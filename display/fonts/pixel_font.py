"""Pixel-perfect bitmap fonts for LED matrix displays."""

from PIL import Image, ImageDraw


# 5x7 pixel font - for small text
FONT_5X7 = {
    '0': ["01110", "10001", "10011", "10101", "11001", "10001", "01110"],
    '1': ["00100", "01100", "00100", "00100", "00100", "00100", "01110"],
    '2': ["01110", "10001", "00001", "00110", "01000", "10000", "11111"],
    '3': ["01110", "10001", "00001", "00110", "00001", "10001", "01110"],
    '4': ["00010", "00110", "01010", "10010", "11111", "00010", "00010"],
    '5': ["11111", "10000", "11110", "00001", "00001", "10001", "01110"],
    '6': ["00110", "01000", "10000", "11110", "10001", "10001", "01110"],
    '7': ["11111", "00001", "00010", "00100", "01000", "01000", "01000"],
    '8': ["01110", "10001", "10001", "01110", "10001", "10001", "01110"],
    '9': ["01110", "10001", "10001", "01111", "00001", "00010", "01100"],
    ':': ["000", "010", "010", "000", "010", "010", "000"],
    ' ': ["00000", "00000", "00000", "00000", "00000", "00000", "00000"],
    '.': ["00", "00", "00", "00", "00", "11", "11"],
    ',': ["00", "00", "00", "00", "01", "01", "10"],
    '-': ["00000", "00000", "00000", "11111", "00000", "00000", "00000"],
    '°': ["0110", "1001", "0110", "0000", "0000", "0000", "0000"],
    '%': ["11001", "11010", "00100", "00100", "00100", "01011", "10011"],
    '/': ["00001", "00010", "00010", "00100", "01000", "01000", "10000"],
    'A': ["01110", "10001", "10001", "11111", "10001", "10001", "10001"],
    'B': ["11110", "10001", "10001", "11110", "10001", "10001", "11110"],
    'C': ["01110", "10001", "10000", "10000", "10000", "10001", "01110"],
    'D': ["11110", "10001", "10001", "10001", "10001", "10001", "11110"],
    'E': ["11111", "10000", "10000", "11110", "10000", "10000", "11111"],
    'F': ["11111", "10000", "10000", "11110", "10000", "10000", "10000"],
    'G': ["01110", "10001", "10000", "10111", "10001", "10001", "01110"],
    'H': ["10001", "10001", "10001", "11111", "10001", "10001", "10001"],
    'I': ["01110", "00100", "00100", "00100", "00100", "00100", "01110"],
    'J': ["00111", "00010", "00010", "00010", "00010", "10010", "01100"],
    'K': ["10001", "10010", "10100", "11000", "10100", "10010", "10001"],
    'L': ["10000", "10000", "10000", "10000", "10000", "10000", "11111"],
    'M': ["10001", "11011", "10101", "10101", "10001", "10001", "10001"],
    'N': ["10001", "10001", "11001", "10101", "10011", "10001", "10001"],
    'O': ["01110", "10001", "10001", "10001", "10001", "10001", "01110"],
    'P': ["11110", "10001", "10001", "11110", "10000", "10000", "10000"],
    'Q': ["01110", "10001", "10001", "10001", "10101", "10010", "01101"],
    'R': ["11110", "10001", "10001", "11110", "10100", "10010", "10001"],
    'S': ["01110", "10001", "10000", "01110", "00001", "10001", "01110"],
    'T': ["11111", "00100", "00100", "00100", "00100", "00100", "00100"],
    'U': ["10001", "10001", "10001", "10001", "10001", "10001", "01110"],
    'V': ["10001", "10001", "10001", "10001", "10001", "01010", "00100"],
    'W': ["10001", "10001", "10001", "10101", "10101", "10101", "01010"],
    'X': ["10001", "10001", "01010", "00100", "01010", "10001", "10001"],
    'Y': ["10001", "10001", "01010", "00100", "00100", "00100", "00100"],
    'Z': ["11111", "00001", "00010", "00100", "01000", "10000", "11111"],
    'a': ["00000", "00000", "01110", "00001", "01111", "10001", "01111"],
    'b': ["10000", "10000", "10110", "11001", "10001", "10001", "11110"],
    'c': ["00000", "00000", "01110", "10000", "10000", "10001", "01110"],
    'd': ["00001", "00001", "01101", "10011", "10001", "10001", "01111"],
    'e': ["00000", "00000", "01110", "10001", "11111", "10000", "01110"],
    'f': ["00110", "01001", "01000", "11100", "01000", "01000", "01000"],
    'g': ["00000", "01111", "10001", "01111", "00001", "10001", "01110"],
    'h': ["10000", "10000", "10110", "11001", "10001", "10001", "10001"],
    'i': ["00100", "00000", "01100", "00100", "00100", "00100", "01110"],
    'j': ["00010", "00000", "00110", "00010", "00010", "10010", "01100"],
    'k': ["10000", "10000", "10010", "10100", "11000", "10100", "10010"],
    'l': ["01100", "00100", "00100", "00100", "00100", "00100", "01110"],
    'm': ["00000", "00000", "11010", "10101", "10101", "10001", "10001"],
    'n': ["00000", "00000", "10110", "11001", "10001", "10001", "10001"],
    'o': ["00000", "00000", "01110", "10001", "10001", "10001", "01110"],
    'p': ["00000", "00000", "11110", "10001", "11110", "10000", "10000"],
    'q': ["00000", "00000", "01101", "10011", "01111", "00001", "00001"],
    'r': ["00000", "00000", "10110", "11001", "10000", "10000", "10000"],
    's': ["00000", "00000", "01110", "10000", "01110", "00001", "11110"],
    't': ["01000", "01000", "11100", "01000", "01000", "01001", "00110"],
    'u': ["00000", "00000", "10001", "10001", "10001", "10011", "01101"],
    'v': ["00000", "00000", "10001", "10001", "10001", "01010", "00100"],
    'w': ["00000", "00000", "10001", "10001", "10101", "10101", "01010"],
    'x': ["00000", "00000", "10001", "01010", "00100", "01010", "10001"],
    'y': ["00000", "00000", "10001", "10001", "01111", "00001", "01110"],
    'z': ["00000", "00000", "11111", "00010", "00100", "01000", "11111"],
    '!': ["00100", "00100", "00100", "00100", "00100", "00000", "00100"],
    '?': ["01110", "10001", "00001", "00010", "00100", "00000", "00100"],
}

# Large 16x24 font for big clock display on 64x64 - fills the screen properly
FONT_LARGE = {
    '0': [
        "..111111111111..",
        ".11111111111111.",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        ".11111111111111.",
        "..111111111111..",
    ],
    '1': [
        "......1111......",
        ".....11111......",
        "....111111......",
        "...1111111......",
        "..11111111......",
        ".111..1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "......1111......",
        "1111111111111111",
        "1111111111111111",
    ],
    '2': [
        "..111111111111..",
        ".11111111111111.",
        "1111........1111",
        "1111........1111",
        "............1111",
        "............1111",
        "............1111",
        "...........1111.",
        "..........1111..",
        ".........1111...",
        "........1111....",
        ".......1111.....",
        "......1111......",
        ".....1111.......",
        "....1111........",
        "...1111.........",
        "..1111..........",
        ".1111...........",
        "1111............",
        "1111............",
        "1111............",
        "1111............",
        "1111111111111111",
        "1111111111111111",
    ],
    '3': [
        "..111111111111..",
        ".11111111111111.",
        "1111........1111",
        "1111........1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "....111111111111",
        "....111111111111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "1111........1111",
        "1111........1111",
        ".11111111111111.",
        "..111111111111..",
    ],
    '4': [
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111111111111111",
        "1111111111111111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
    ],
    '5': [
        "1111111111111111",
        "1111111111111111",
        "1111............",
        "1111............",
        "1111............",
        "1111............",
        "1111............",
        "1111............",
        "1111............",
        "1111............",
        "111111111111....",
        "1111111111111...",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "1111........1111",
        "1111........1111",
        ".11111111111111.",
        "..111111111111..",
    ],
    '6': [
        "..111111111111..",
        ".11111111111111.",
        "1111........1111",
        "1111............",
        "1111............",
        "1111............",
        "1111............",
        "1111............",
        "1111............",
        "1111............",
        "111111111111....",
        "1111111111111...",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        ".11111111111111.",
        "..111111111111..",
    ],
    '7': [
        "1111111111111111",
        "1111111111111111",
        "............1111",
        "............1111",
        "...........1111.",
        "..........1111..",
        ".........1111...",
        "........1111....",
        ".......1111.....",
        "......1111......",
        ".....1111.......",
        "....1111........",
        "....1111........",
        "....1111........",
        "....1111........",
        "....1111........",
        "....1111........",
        "....1111........",
        "....1111........",
        "....1111........",
        "....1111........",
        "....1111........",
        "....1111........",
        "....1111........",
    ],
    '8': [
        "..111111111111..",
        ".11111111111111.",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        ".11111111111111.",
        ".11111111111111.",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        ".11111111111111.",
        "..111111111111..",
    ],
    '9': [
        "..111111111111..",
        ".11111111111111.",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        "1111........1111",
        ".111111111111111",
        "..11111111111111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "............1111",
        "1111........1111",
        "1111........1111",
        ".11111111111111.",
        "..111111111111..",
    ],
    ':': [
        "....",
        "....",
        "....",
        "....",
        "1111",
        "1111",
        "1111",
        "1111",
        "....",
        "....",
        "....",
        "....",
        "....",
        "....",
        "....",
        "....",
        "1111",
        "1111",
        "1111",
        "1111",
        "....",
        "....",
        "....",
        "....",
    ],
    ' ': [
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
        "........",
    ],
}

# Medium 8x12 font - good for secondary info on 64x64
FONT_MEDIUM = {
    '0': ["..1111..", ".11..11.", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", ".11..11.", "..1111.."],
    '1': ["...11...", "..111...", ".1111...", "...11...", "...11...", "...11...", "...11...", "...11...", "...11...", "...11...", "...11...", ".111111."],
    '2': ["..1111..", ".11..11.", "11....11", "......11", ".....11.", "....11..", "...11...", "..11....", ".11.....", "11......", "11......", "11111111"],
    '3': ["..1111..", ".11..11.", "11....11", "......11", "......11", "...1111.", "......11", "......11", "......11", "11....11", ".11..11.", "..1111.."],
    '4': ["11....11", "11....11", "11....11", "11....11", "11....11", "11111111", "......11", "......11", "......11", "......11", "......11", "......11"],
    '5': ["11111111", "11......", "11......", "11......", "111111..", "......11", "......11", "......11", "......11", "11....11", ".11..11.", "..1111.."],
    '6': ["..1111..", ".11..11.", "11......", "11......", "111111..", "11....11", "11....11", "11....11", "11....11", "11....11", ".11..11.", "..1111.."],
    '7': ["11111111", "......11", "......11", ".....11.", "....11..", "...11...", "..11....", "..11....", "..11....", "..11....", "..11....", "..11...."],
    '8': ["..1111..", ".11..11.", "11....11", "11....11", ".11..11.", "..1111..", ".11..11.", "11....11", "11....11", "11....11", ".11..11.", "..1111.."],
    '9': ["..1111..", ".11..11.", "11....11", "11....11", "11....11", ".1111111", "......11", "......11", "......11", "11....11", ".11..11.", "..1111.."],
    ':': ["....", "....", "....", "11..", "11..", "....", "....", "11..", "11..", "....", "....", "...."],
    ' ': ["......", "......", "......", "......", "......", "......", "......", "......", "......", "......", "......", "......"],
    '.': ["..", "..", "..", "..", "..", "..", "..", "..", "..", "..", "11", "11"],
    '°': ["0110", "1001", "1001", "0110", "0000", "0000", "0000", "0000", "0000", "0000", "0000", "0000"],
    'A': ["..1111..", ".11..11.", "11....11", "11....11", "11....11", "11111111", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11"],
    'B': ["111111..", "11....11", "11....11", "11....11", "111111..", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", "111111.."],
    'C': ["..111111", ".11.....", "11......", "11......", "11......", "11......", "11......", "11......", "11......", "11......", ".11.....", "..111111"],
    'D': ["11111...", "11...11.", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", "11...11.", "11111..."],
    'E': ["11111111", "11......", "11......", "11......", "111111..", "11......", "11......", "11......", "11......", "11......", "11......", "11111111"],
    'F': ["11111111", "11......", "11......", "11......", "111111..", "11......", "11......", "11......", "11......", "11......", "11......", "11......"],
    'M': ["11....11", "111..111", "11.11.11", "11.11.11", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11"],
    'P': ["111111..", "11....11", "11....11", "11....11", "111111..", "11......", "11......", "11......", "11......", "11......", "11......", "11......"],
    'a': ["........", "........", "........", "..1111..", ".11..11.", "......11", ".1111111", "11....11", "11....11", "11...111", ".111..11", "........"],
    'b': ["11......", "11......", "11......", "11.111..", "111...11", "11....11", "11....11", "11....11", "11....11", "111...11", "11.111..", "........"],
    'e': ["........", "........", "........", "..1111..", ".11..11.", "11....11", "11111111", "11......", "11......", ".11...11", "..11111.", "........"],
    'n': ["........", "........", "........", "11.111..", "111...11", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", "........"],
    'o': ["........", "........", "........", "..1111..", ".11..11.", "11....11", "11....11", "11....11", "11....11", ".11..11.", "..1111..", "........"],
    'u': ["........", "........", "........", "11....11", "11....11", "11....11", "11....11", "11....11", "11....11", "11...111", ".111..11", "........"],
}


class PixelFont:
    """Renders text using pixel-perfect bitmap fonts."""

    def __init__(self, font_data: dict = None, char_spacing: int = 1):
        self.font_data = font_data or FONT_5X7
        self.char_spacing = char_spacing
        self._calculate_dimensions()

    def _calculate_dimensions(self):
        """Calculate font dimensions from data."""
        if self.font_data:
            first_char = next(iter(self.font_data.values()))
            self.char_height = len(first_char)
            self.char_width = len(first_char[0]) if first_char else 0
        else:
            self.char_height = 7
            self.char_width = 5

    def get_char_width(self, char: str) -> int:
        """Get width of a specific character."""
        if char in self.font_data:
            return len(self.font_data[char][0])
        return self.char_width

    def get_text_width(self, text: str) -> int:
        """Get the pixel width of rendered text."""
        if not text:
            return 0
        width = 0
        for i, char in enumerate(text):
            width += self.get_char_width(char)
            if i < len(text) - 1:
                width += self.char_spacing
        return width

    def render_char(self, image: Image.Image, char: str, x: int, y: int, color: tuple[int, int, int]) -> int:
        """Render a single character. Returns character width."""
        if char not in self.font_data:
            return self.get_char_width(char)

        bitmap = self.font_data[char]
        pixels = image.load()

        for row_idx, row in enumerate(bitmap):
            for col_idx, pixel in enumerate(row):
                if pixel == '1':
                    px = x + col_idx
                    py = y + row_idx
                    if 0 <= px < image.width and 0 <= py < image.height:
                        pixels[px, py] = color

        return len(bitmap[0]) if bitmap else 0

    def render_text(self, image: Image.Image, text: str, x: int, y: int, color: tuple[int, int, int]) -> int:
        """Render text to an image. Returns total width."""
        cursor_x = x
        for i, char in enumerate(text):
            char_width = self.render_char(image, char, cursor_x, y, color)
            cursor_x += char_width
            if i < len(text) - 1:
                cursor_x += self.char_spacing
        return cursor_x - x

    def render_text_centered(self, image: Image.Image, text: str, y: int, color: tuple[int, int, int]) -> None:
        """Render horizontally centered text."""
        text_width = self.get_text_width(text)
        x = (image.width - text_width) // 2
        self.render_text(image, text, x, y, color)


# Pre-instantiated fonts
small_font = PixelFont(FONT_5X7, char_spacing=1)
medium_font = PixelFont(FONT_MEDIUM, char_spacing=1)
large_font = PixelFont(FONT_LARGE, char_spacing=2)
